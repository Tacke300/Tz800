<!DOCTYPE html>
<html>
<head>
  <title>USDT Balance Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>USDT Balance</h2>
  <pre id="balance">Đang tải...</pre>

  <script>
    const supabaseUrl = 'https://tramnanrzruzvkehpydl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYW1uYW5yenJ1enZrZWhweWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTM1NTMsImV4cCI6MjA2MTMyOTU1M30.L0Ytkxi80AbYjkjpDfGyQtfyfqjfHLF98OrVce9Hi-0';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const user_id = localStorage.getItem('user_id');

    async function getUserData() {
      const { data, error } = await supabase
        .from('users')
        .select('apikey_binance, secret_binance')
        .eq('user_id', user_id)
        .single();
      if (error || !data) return null;
      return data;
    }

    async function signRequest(queryString, secret) {
      const encoder = new TextEncoder();
      const key = await crypto.subtle.importKey(
        'raw',
        encoder.encode(secret),
        { name: 'HMAC', hash: 'SHA-256' },
        false,
        ['sign']
      );
      const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(queryString));
      return [...new Uint8Array(signature)].map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function getSpotBalance(apiKey, secretKey) {
      const endpoint = 'https://api.binance.com/sapi/v1/capital/config/getall';
      const timestamp = Date.now();
      const query = `timestamp=${timestamp}`;
      const signature = await signRequest(query, secretKey);

      const res = await fetch(`${endpoint}?${query}&signature=${signature}`, {
        method: 'GET',
        headers: { 'X-MBX-APIKEY': apiKey }
      });
      const data = await res.json();
      if (!Array.isArray(data)) return 0;

      const usdt = data.find(a => a.asset === 'USDT');
      return usdt ? parseFloat(usdt.free) : 0;
    }

    async function getFuturesBalance(apiKey, secretKey, type = 'usdm') {
      const base = type === 'usdm' ? 'fapi' : 'dapi'; // usdm or coinm
      const endpoint = `https://api.binance.com/${base}/v2/account`;
      const timestamp = Date.now();
      const query = `timestamp=${timestamp}`;
      const signature = await signRequest(query, secretKey);

      const res = await fetch(`${endpoint}?${query}&signature=${signature}`, {
        method: 'GET',
        headers: { 'X-MBX-APIKEY': apiKey }
      });

      const data = await res.json();
      if (!Array.isArray(data.assets)) return 0;

      const usdt = data.assets.find(a => a.asset === 'USDT');
      return usdt ? parseFloat(usdt.walletBalance) : 0;
    }

    async function updateBalance(usdtTotal) {
      await supabase
        .from('users')
        .update({ usdt_balance: usdtTotal })
        .eq('user_id', user_id);
    }

    function formatUSD(val) {
      return '$' + val.toLocaleString('en-US', { minimumFractionDigits: 8 });
    }

    async function run() {
      const user = await getUserData();
      if (!user) {
        document.getElementById('balance').textContent = 'Không tìm thấy user hoặc thiếu API key.';
        return;
      }

      const spot = await getSpotBalance(user.apikey_binance, user.secret_binance);
      const usdm = await getFuturesBalance(user.apikey_binance, user.secret_binance, 'usdm');
      const coinm = await getFuturesBalance(user.apikey_binance, user.secret_binance, 'coinm');

      const total = spot + usdm + coinm;
      await updateBalance(total);

      let output = `Tổng USDT: ${formatUSD(total)}\n`;
      output += `- Spot: ${formatUSD(spot)}\n`;
      output += `- USD-M: ${formatUSD(usdm)}\n`;
      output += `- COIN-M: ${formatUSD(coinm)}\n`;

      document.getElementById('balance').textContent = output;
    }

    run();
  </script>
</body>
</html>
