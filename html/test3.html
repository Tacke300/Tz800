<!DOCTYPE html>
<html>
<head>
  <title>Binance Full Balance</title>
  <style>
    body { font-family: Arial; }
    pre { background: #f9f9f9; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>

<h2>Binance All Balances (Spot, USDM, COINM)</h2>
<pre id="log">Đang tải...</pre>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
const SUPABASE_URL = 'https://tramnanrzruzvkehpydl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYW1uYW5yenJ1enZrZWhweWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTM1NTMsImV4cCI6MjA2MTMyOTU1M30.L0Ytkxi80AbYjkjpDfGyQtfyfqjfHLF98OrVce9Hi-0';

import fetch from 'node-fetch';
import CryptoJS from 'crypto-js';


// 1. Lấy API key/secret từ Supabase
async function getApiKeysFromSupabase(user_id) {
  const encodedUserId = encodeURIComponent(user_id);
  const url = `${SUPABASE_URL}/rest/v1/users?select=apikey_binance,secret_binance&user_id=eq.${encodedUserId}`;
  const res = await fetch(url, {
    headers: {
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    },
  });

  if (!res.ok) {
    const errText = await res.text();
    throw new Error(`Failed to fetch user keys from Supabase: ${errText}`);
  }

  const data = await res.json();
  if (data.length === 0) throw new Error('User not found or no API keys');

  return { apiKey: data[0].apikey_binance, apiSecret: data[0].secret_binance };
}

// 2. Lấy server time Binance (để đồng bộ timestamp)
async function getServerTime() {
  const res = await fetch('https://api.binance.com/api/v3/time');
  if (!res.ok) throw new Error('Failed to fetch Binance server time');
  const data = await res.json();
  return data.serverTime;
}

// 3. Ký query string
function signQuery(queryString, secret) {
  return CryptoJS.HmacSHA256(queryString, secret).toString(CryptoJS.enc.Hex);
}

// 4. Gọi API Binance có ký
async function signedRequest(apiKey, secret, endpoint, base = 'https://api.binance.com', params = {}) {
  const timestamp = await getServerTime();
  params.timestamp = timestamp;

  const query = new URLSearchParams(params).toString();
  const signature = signQuery(query, secret);
  const url = `${base}${endpoint}?${query}&signature=${signature}`;

  const res = await fetch(url, {
    headers: { 'X-MBX-APIKEY': apiKey }
  });

  if (!res.ok) {
    const errText = await res.text();
    throw new Error(`Binance API error: ${res.status} ${errText}`);
  }

  return res.json();
}

// 5. Ví dụ: lấy số dư tài khoản Spot
async function fetchSpotBalance(userId) {
  try {
    const { apiKey, apiSecret } = await getApiKeysFromSupabase(userId);
    const accountInfo = await signedRequest(apiKey, apiSecret, '/api/v3/account');
    return accountInfo.balances;
  } catch (error) {
    console.error('Error fetching spot balance:', error.message);
    return null;
  }
}

// --- chạy thử ---
// Thay userId thành cái bạn cần lấy API key/secret
fetchSpotBalance('user123').then(balances => {
  if (balances) {
    console.log('Spot balances:', balances);
  } else {
    console.log('Không lấy được số dư');
  }
});
</script>

</body>
</html>
