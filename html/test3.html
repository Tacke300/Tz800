<!DOCTYPE html>
<html>
<head>
  <title>USDT Balance Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>USDT Balance</h2>
  <pre id="balance"></pre>

  <script>
    // Cấu hình Supabase
    const supabaseUrl = 'https://tramnanrzruzvkehpydl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYW1uYW5yenJ1enZrZWhweWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTM1NTMsImV4cCI6MjA2MTMyOTU1M30.L0Ytkxi80AbYjkjpDfGyQtfyfqjfHLF98OrVce9Hi-0';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const user_id = localStorage.getItem('user_id');

    async function getUserData() {
      const { data, error } = await supabase
        .from('users')
        .select('apikey_binance, secret_binance')
        .eq('user_id', user_id)
        .single();

      if (error || !data) {
        document.getElementById('balance').textContent = 'User not found or Supabase error.';
        return null;
      }
      return data;
    }

    async function getBinanceBalances(apiKey, secretKey) {
      const endpoint = 'https://api.binance.com/sapi/v1/capital/config/getall';
      const timestamp = Date.now();
      const query = `timestamp=${timestamp}`;
      const signature = await signRequest(query, secretKey);

      const res = await fetch(`${endpoint}?${query}&signature=${signature}`, {
        method: 'GET',
        headers: {
          'X-MBX-APIKEY': apiKey
        }
      });

      const data = await res.json();
      return data;
    }

    async function signRequest(queryString, secret) {
      const encoder = new TextEncoder();
      const key = await crypto.subtle.importKey(
        'raw',
        encoder.encode(secret),
        { name: 'HMAC', hash: 'SHA-256' },
        false,
        ['sign']
      );
      const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(queryString));
      return [...new Uint8Array(signature)].map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function updateBalanceOnSupabase(usdtTotal) {
      await supabase
        .from('users')
        .update({ usdt_balance: usdtTotal })
        .eq('user_id', user_id);
    }

    async function run() {
      const user = await getUserData();
      if (!user) return;

      const balances = await getBinanceBalances(user.apikey_binance, user.secret_binance);
      if (!Array.isArray(balances)) {
        document.getElementById('balance').textContent = 'Error fetching Binance balances.';
        return;
      }

      let usdtTotal = 0;
      let balanceDetails = [];

      for (let item of balances) {
        if (item.asset === 'USDT' && parseFloat(item.free) > 0) {
          usdtTotal += parseFloat(item.free);
          balanceDetails.push(`${item.asset} - ${item.free} (${item.name})`);
        }
      }

      await updateBalanceOnSupabase(usdtTotal);
      document.getElementById('balance').textContent = `Total USDT: ${usdtTotal.toFixed(2)}\n` + balanceDetails.join('\n');
    }

    run();
  </script>
</body>
</html>
