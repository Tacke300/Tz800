<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Binance Balance Viewer</title>

  <!-- Ch·ªâ d√πng 1 th∆∞ vi·ªán CryptoJS -->
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    pre { background: #f3f3f3; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Binance Balances (SPOT, USDM, COINM)</h2>
  <pre id="log">Loading...</pre>

<script>
const SUPABASE_URL = 'https://tramnanrzruzvkehpydl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYW1uYW5yenJ1enZrZWhweWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTM1NTMsImV4cCI6MjA2MTMyOTU1M30.L0Ytkxi80AbYjkjpDfGyQtfyfqjfHLF98OrVce9Hi-0'; // r√∫t g·ªçn v√¨ l√Ω do b·∫£o m·∫≠t
const userId = localStorage.getItem('loggedInUser');
const logEl = document.getElementById('log');

function log(msg) {
  console.log(msg);
  logEl.textContent += msg + '\n';
}

function signQuery(query, secret) {
  return CryptoJS.HmacSHA256(query, secret).toString(CryptoJS.enc.Hex);
}

async function signedRequest(apiKey, apiSecret, endpoint, baseUrl, params = {}) {
  params.timestamp = Date.now();
  const query = new URLSearchParams(params).toString();
  const signature = signQuery(query, apiSecret);
  const url = `${baseUrl}${endpoint}?${query}&signature=${signature}`;

  const res = await fetch(url, { headers: { 'X-MBX-APIKEY': apiKey } });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Binance API error: ${res.status} ${err}`);
  }
  return res.json();
}

async function getApiKeys(userId) {
  const url = `${SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`;
  const res = await fetch(url, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      Accept: 'application/json'
    }
  });
  const data = await res.json();
  if (!data || data.length === 0) throw new Error("Kh√¥ng t√¨m th·∫•y user ho·∫∑c API.");
  return {
    apiKey: data[0].binance_api_key,
    apiSecret: data[0].binance_api_secret
  };
}

async function saveUSDTBalance(userId, totalUSDT) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`, {
    method: 'PATCH',
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
      Prefer: 'return=representation'
    },
    body: JSON.stringify({ usdt_binance: totalUSDT })
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase update error: ${res.status} ${err}`);
  }
}

async function fetchAllBalances() {
  try {
    log(`‚ñ∂ L·∫•y API key cho user: ${userId}`);
    const { apiKey, apiSecret } = await getApiKeys(userId);
    log(`‚úî API key OK\n`);

    let totalUSDT = 0;

    // SPOT
    log(`‚ñ∂ L·∫•y s·ªë d∆∞ SPOT...`);
    const spot = await signedRequest(apiKey, apiSecret, '/sapi/v1/capital/config/getall', 'https://api.binance.com');
    spot.filter(c => parseFloat(c.free) > 0 || parseFloat(c.locked) > 0).forEach(c => {
      const sum = parseFloat(c.free) + parseFloat(c.locked);
      log(`${c.coin}: ${sum}`);
      if (c.coin === 'USDT') totalUSDT += sum;
    });

    // USDM
    log(`\n‚ñ∂ L·∫•y s·ªë d∆∞ USDM...`);
    const usdm = await signedRequest(apiKey, apiSecret, '/fapi/v2/account', 'https://fapi.binance.com');
    usdm.assets.filter(a => parseFloat(a.walletBalance) > 0).forEach(a => {
      log(`${a.asset}: ${a.walletBalance}`);
      if (a.asset === 'USDT') totalUSDT += parseFloat(a.walletBalance);
    });

    // COINM
    log(`\n‚ñ∂ L·∫•y s·ªë d∆∞ COINM...`);
    const coinm = await signedRequest(apiKey, apiSecret, '/dapi/v1/account', 'https://dapi.binance.com');
    coinm.assets.filter(a => parseFloat(a.walletBalance) > 0).forEach(a => {
      log(`${a.asset}: ${a.walletBalance}`);
      if (a.asset === 'USDT') totalUSDT += parseFloat(a.walletBalance);
    });

    log(`\nüí∞ T·ªïng USDT: ${totalUSDT.toFixed(2)}`);
    await saveUSDTBalance(userId, totalUSDT.toFixed(2));
    log(`\n‚úÖ ƒê√£ l∆∞u v√†o Supabase.`);
  } catch (e) {
    log(`‚ùå L·ªói: ${e.message}`);
  }
}

fetchAllBalances();
</script>
</body>
</html>
