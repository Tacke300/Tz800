<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Binance Balance Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    pre { background: #f3f3f3; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Binance Balances (SPOT, USDM, COINM)</h2>
  <pre id="log">Loading...</pre>

<script>
const SUPABASE_URL = 'https://tramnanrzruzvkehpydl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYW1uYW5yenJ1enZrZWhweWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTM1NTMsImV4cCI6MjA2MTMyOTU1M30.L0Ytkxi80AbYjkjpDfGyQtfyfqjfHLF98OrVce9Hi-0'; // Rút gọn
const userId = localStorage.getItem('loggedInUser');
const logEl = document.getElementById('log');

function log(msg) {
  console.log(msg);
  logEl.textContent += msg + '\n';
}

// Hàm ký HMAC SHA256 (chuẩn WebCrypto, không lỗi)

  // Ký query với HMAC SHA256 (dùng CryptoJS)
  function signQuery(queryString, secret) {
    return CryptoJS.HmacSHA256(queryString, secret).toString(CryptoJS.enc.Hex);
  }

// Lấy API Key từ Supabase
async function getApiKeys(userId) {
  const url = `${SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`;
  const res = await fetch(url, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      Accept: 'application/json'
    }
  });
  const data = await res.json();
  if (!data || data.length === 0) throw new Error("User không tồn tại hoặc không có API key.");
  return {
    apiKey: data[0].binance_api_key,
    apiSecret: data[0].binance_api_secret
  };
}

// Gửi request có ký HMAC
async function signedRequest(apiKey, apiSecret, endpoint, baseUrl, params = {}) {
  params.timestamp = Date.now();
  const query = new URLSearchParams(params).toString();
  const signature = await hmacSHA256(apiSecret, query);
  const url = `${baseUrl}${endpoint}?${query}&signature=${signature}`;

  const res = await fetch(url, {
    headers: { 'X-MBX-APIKEY': apiKey }
  });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`Request failed: ${res.status} ${text}`);
  }
  return res.json();
}

// Hàm chính
async function fetchAllBalances() {
  try {
    log(`▶ Đang lấy API key từ Supabase cho user_id: ${userId}`);
    const { apiKey, apiSecret } = await getApiKeys(userId);
    log(`✔ API key đã sẵn sàng\n`);

    // SPOT
    log(`▶ Đang lấy số dư SPOT...`);
    const spot = await signedRequest(apiKey, apiSecret, '/sapi/v1/capital/config/getall', 'https://api.binance.com');
    spot.filter(c => parseFloat(c.free) > 0 || parseFloat(c.locked) > 0)
        .forEach(c => log(`${c.coin}: ${parseFloat(c.free) + parseFloat(c.locked)}`));

    // USDM Futures
    log(`\n▶ Đang lấy số dư USDM...`);
    const usdm = await signedRequest(apiKey, apiSecret, '/fapi/v2/account', 'https://fapi.binance.com');
    usdm.assets.filter(a => parseFloat(a.walletBalance) !== 0)
        .forEach(a => log(`${a.asset}: ${a.walletBalance}`));

    // COINM Futures
    log(`\n▶ Đang lấy số dư COINM...`);
    const coinm = await signedRequest(apiKey, apiSecret, '/dapi/v1/account', 'https://dapi.binance.com');
    coinm.assets.filter(a => parseFloat(a.walletBalance) !== 0)
        .forEach(a => log(`${a.asset}: ${a.walletBalance}`));

    log(`\n✅ Xong!`);
  } catch (e) {
    log(`❌ Lỗi: ${e.message}`);
  }
}

fetchAllBalances();
</script>
</body>
</html>
