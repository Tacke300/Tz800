<!DOCTYPE html><html>
<head>
  <title>Funding Carry Bot</title>
  <style>
    #log {
      white-space: pre-line;
      background: #111;
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      max-height: 400px;
      overflow-y: scroll;
    }
  </style>
</head>
<body>
  <h2>Funding Carry Bot</h2>
  <div id="log"></div>  <script>
    const SUPABASE_URL = 'https://your-project.supabase.co';
    const SUPABASE_KEY = 'your-supabase-api-key';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function log(message) {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerText += `[${timestamp}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function logError(error) {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerText += `[${timestamp}] ERROR: ${error}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function startBot() {
      log("Đang lấy user_id từ localStorage...");
      const userId = localStorage.getItem('loggedInUser');
      if (!userId) {
        logError("Không có user_id trong localStorage");
        return;
      }
      log(`user_id: ${userId}`);

      log("Đang kiểm tra user trên Supabase...");
      let { data: user, error } = await supabase
        .from('users')
        .select('*')
        .eq('user_id', userId)
        .single();

      if (error || !user) {
        logError("Không tìm thấy user hoặc lỗi Supabase: " + error?.message);
        return;
      }
      log("User hợp lệ, đã lấy được API Key.");

      const apiKey = user.apikey_binance;
      const apiSecret = user.secret_binance;
      const usdtBalance = user.usdt_binance;

      log("Bắt đầu quét funding rate từ sàn...");
      try {
        const fundingData = await fetchFundingRates(apiKey, apiSecret);
        log("Đã lấy funding rates.");

        const filtered = filterTopNegativeFunding(fundingData);
        if (filtered.length === 0) {
          log("Không có coin nào đủ điều kiện âm < -0.005.");
          return;
        }

        const bestCoin = pickNextFunding(filtered);
        if (!bestCoin) {
          log("Không có coin nào sắp tới trả funding.");
          return;
        }

        log(`Chọn coin ${bestCoin.symbol} funding âm nhất sắp trả, chuẩn bị mở lệnh.`);

        const lev = bestCoin.leverage;
        const positionSize = calculatePositionSize(usdtBalance, lev);

        log("Chuẩn bị mở lệnh SHORT...");
        try {
          const res = await openShortOrder(bestCoin.symbol, positionSize, lev, apiKey, apiSecret);
          log("Lệnh SHORT đã gửi thành công.");
        } catch (err) {
          logError("Gửi lệnh thất bại: " + err.message);
        }

      } catch (err) {
        logError("Lỗi khi lấy dữ liệu funding: " + err.message);
      }
    }

    function fetchFundingRates(apiKey, apiSecret) {
      // Dummy để ví dụ, bạn thay bằng logic gọi Binance API
      log("Giả lập fetch funding...");
      return Promise.resolve([
        { symbol: "BTCUSDT", fundingRate: -0.006, leverage: 50, nextFunding: Date.now() + 2 * 60 * 1000 },
        { symbol: "ETHUSDT", fundingRate: -0.004, leverage: 20, nextFunding: Date.now() + 5 * 60 * 1000 }
      ]);
    }

    function filterTopNegativeFunding(data) {
      return data.filter(c => c.fundingRate < -0.005);
    }

    function pickNextFunding(coins) {
      return coins.sort((a, b) => a.nextFunding - b.nextFunding)[0];
    }

    function calculatePositionSize(balance, lev) {
      return balance * 0.3; // giả lập bot_mini 30%
    }

    function openShortOrder(symbol, size, lev, apiKey, apiSecret) {
      log(`Gửi lệnh short ${symbol} size ${size} lev ${lev}`);
      return Promise.resolve({ status: "ok" });
    }

    startBot();
  </script>  <!-- Thêm Supabase script -->  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script></body>
</html>
