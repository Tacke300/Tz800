<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thông tin Binance</title>
</head>
<body>
  <h1>Thông tin Tài Khoản Binance</h1>
  <pre id="output">Đang tải...</pre>

  <script>
    async function getApiKeys(user_id) {
      const res = await fetch(`/api/keys?user=${encodeURIComponent(user_id)}`);
      if (!res.ok) throw new Error(`Lỗi API keys: ${res.status}`);
      const json = await res.json();

      if (!json.apikey_binance || !json.secret_binance) {
        throw new Error('Thiếu apikey_binance hoặc secret_binance');
      }

      return json;
    }

    async function getBinanceBalanceAndLeverage(apiKey, apiSecret) {
      const timestamp = Date.now();
      const recvWindow = 5000;

      const params = new URLSearchParams({
        timestamp,
        recvWindow,
      });

      const queryString = params.toString();
      const signature = await sign(queryString, apiSecret);
      const url = `https://fapi.binance.com/fapi/v2/account?${queryString}&signature=${signature}`;

      const res = await fetch(url, {
        method: 'GET',
        headers: { 'X-MBX-APIKEY': apiKey }
      });

      if (!res.ok) throw new Error(`Lỗi Binance account: ${res.status}`);
      const data = await res.json();

      const usdtWallet = data.assets.find(a => a.asset === 'USDT')?.walletBalance || '0';
      const maxLev = data.positions.reduce((max, pos) => {
        const lev = parseFloat(pos.leverage);
        return lev > max ? lev : max;
      }, 0);

      return {
        usdtWallet,
        maxLev
      };
    }

    async function sign(queryString, secret) {
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey(
        'raw',
        enc.encode(secret),
        { name: 'HMAC', hash: 'SHA-256' },
        false,
        ['sign']
      );
      const sig = await crypto.subtle.sign('HMAC', key, enc.encode(queryString));
      return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function main() {
      const output = document.getElementById('output');
      const user_id = localStorage.getItem('loggedInUser');

      try {
        if (!user_id) throw new Error('Không tìm thấy user_id trong localStorage');

        const keys = await getApiKeys(user_id);
        const info = await getBinanceBalanceAndLeverage(keys.apikey_binance, keys.secret_binance);

        output.textContent = `
API Key Binance: ${keys.apikey_binance}
Số dư ví USDT: ${info.usdtWallet}
Max Leverage: ${info.maxLev}
        `.trim();

      } catch (err) {
        output.textContent = 'Lỗi: ' + err.message;
        console.error(err);
      }
    }

    main();
  </script>
</body>
</html>
