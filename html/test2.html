<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Binance Futures Leverage Info</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #121212; color: #eee; }
  table { border-collapse: collapse; width: 100%; max-width: 900px; margin: auto; }
  th, td { border: 1px solid #444; padding: 8px 12px; text-align: center; }
  th { background-color: #222; }
  tr:nth-child(even) { background-color: #1a1a1a; }
</style>
</head>
<body>

<h1>Binance Futures Leverage Info for User</h1>
<p id="status">Loading...</p>

<table>
  <thead>
    <tr>
      <th>Symbol</th>
      <th>Max Leverage</th>
      <th>Current Leverage</th>
      <th>Position Amount</th>
    </tr>
  </thead>
  <tbody id="table-body">
    <tr><td colspan="4">Loading data...</td></tr>
  </tbody>
</table>

<p id="usdt-balance"></p>

<script>
  // Supabase config
  const SUPABASE_URL = 'https://tramnanrzruzvkehpydl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYW1uYW5yenJ1enZrZWhweWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTM1NTMsImV4cCI6MjA2MTMyOTU1M30.L0Ytkxi80AbYjkjpDfGyQtfyfqjfHLF98OrVce9Hi-0';

  // Biến lưu offset thời gian giữa local và Binance server
  let binanceServerTimeOffset = 0;

  async function getServerTime() {
    const res = await fetch('https://fapi.binance.com/fapi/v1/time');
    if (!res.ok) throw new Error('Failed to get Binance server time');
    const data = await res.json();
    return data.serverTime;
  }

  async function initServerTimeOffset() {
    const serverTime = await getServerTime();
    binanceServerTimeOffset = serverTime - Date.now();
    console.log('Binance server time offset:', binanceServerTimeOffset, 'ms');
  }

  function getTimestamp() {
    return Date.now() + binanceServerTimeOffset;
  }

  // Lấy user keys từ Supabase kèm log chi tiết
  async function getBinanceApiKeys(user_id) {
  const SUPABASE_URL = 'https://tramnanrzruzvkehpydl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYW1uYW5yenJ1enZrZWhweWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTM1NTMsImV4cCI6MjA2MTMyOTU1M30.L0Ytkxi80AbYjkjpDfGyQtfyfqjfHLF98OrVce9Hi-0';

  // Đặt user_id trong dấu nháy kép, rồi encode toàn bộ
  const encodedUserId = encodeURIComponent(`"${user_id}"`);

  const url = `${SUPABASE_URL}/rest/v1/users?select=apikey_binance,secret_binance&id=eq.${encodedUserId}`;

  const res = await fetch(url, {
    headers: {
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    },
  });

  if (!res.ok) {
    const errText = await res.text();
    throw new Error(`Failed to fetch user keys from Supabase: ${errText}`);
  }

  const data = await res.json();
  if (data.length === 0) throw new Error('User not found or no API keys');

  return data[0];
}

  // Ký query với HMAC SHA256 (dùng CryptoJS)
  function signQuery(queryString, secret) {
    return CryptoJS.HmacSHA256(queryString, secret).toString(CryptoJS.enc.Hex);
  }

  // Gọi Binance futures API có ký
  async function binanceFuturesApi(path, apiKey, secret, params = {}) {
    params.timestamp = getTimestamp();
    const query = new URLSearchParams(params).toString();
    const signature = signQuery(query, secret);
    const fullQuery = query + `&signature=${signature}`;

    const url = `https://fapi.binance.com${path}?${fullQuery}`;
    const res = await fetch(url, { headers: { 'X-MBX-APIKEY': apiKey } });
    if (!res.ok) {
      const err = await res.text();
      throw new Error(`Binance API error: ${res.status} ${err}`);
    }
    return res.json();
  }

  // Lấy thông tin exchangeInfo (max leverage từng symbol)
  async function getExchangeInfo() {
    const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
    if (!res.ok) throw new Error('Failed to get exchangeInfo');
    return res.json();
  }

  // Lấy số dư USDT của tài khoản futures
  async function getUsdtBalance(apiKey, secret) {
    const data = await binanceFuturesApi('/fapi/v2/balance', apiKey, secret);
    const usdt = data.find(b => b.asset === 'USDT');
    return usdt ? usdt.balance : '0';
  }

  async function main() {
    const statusEl = document.getElementById('status');
    const tbody = document.getElementById('table-body');
    const usdtBalanceEl = document.getElementById('usdt-balance');
    tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
    usdtBalanceEl.textContent = '';
    statusEl.textContent = 'Initializing...';

    try {
      const user_id = localStorage.getItem('user_id');
      if (!user_id) throw new Error('User ID not found in localStorage');

      statusEl.textContent = `Fetching API keys for user "${user_id}"...`;
      const keys = await getBinanceApiKeys(user_id);

      statusEl.textContent = 'Got API keys. Syncing Binance server time...';
      await initServerTimeOffset();

      statusEl.textContent = 'Fetching Binance data...';

      const [positions, exchangeInfo, usdtBalance] = await Promise.all([
        binanceFuturesApi('/fapi/v2/positionRisk', keys.apikey_binance, keys.secret_binance),
        getExchangeInfo(),
        getUsdtBalance(keys.apikey_binance, keys.secret_binance)
      ]);

      const symbolInfoMap = {};
      for (const sym of exchangeInfo.symbols) {
        const levFilter = sym.filters.find(f => f.filterType === 'LEVERAGE');
        symbolInfoMap[sym.symbol] = levFilter ? levFilter.maxLeverage : 'N/A';
      }

      // map position theo symbol
      const positionMap = {};
      positions.forEach(pos => { positionMap[pos.symbol] = pos; });

      let rows = '';
      for (const symbol in symbolInfoMap) {
        const maxLev = symbolInfoMap[symbol];
        const pos = positionMap[symbol];
        const currentLev = pos ? pos.leverage : '-';
        const positionAmt = pos ? pos.positionAmt : '0';

        rows += `<tr>
          <td>${symbol}</td>
          <td>${maxLev}</td>
          <td>${currentLev}</td>
          <td>${positionAmt}</td>
        </tr>`;
      }

      tbody.innerHTML = rows;
      usdtBalanceEl.textContent = `USDT Futures Balance: ${usdtBalance}`;
      statusEl.textContent = 'Data loaded.';

    } catch (e) {
      statusEl.textContent = `Error: ${e.message}`;
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="4">Error loading data</td></tr>`;
    }
  }

  // Load CryptoJS trước rồi chạy main
  async function loadCryptoAndRun() {
    if (typeof CryptoJS === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
      script.onload = main;
      document.head.appendChild(script);
    } else {
      main();
    }
  }

  loadCryptoAndRun();

</script>
</body>
</html>
