<!DOCTYPE html>
<html>
<head>
  <title>Binance Balance & Leverage</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <h2>Binance Futures Balance & Leverage</h2>
  <pre id="output">Đang tải...</pre>

  <script>
    const SUPABASE_URL = 'https://bgtqxbxtbqbcxqxvqtqg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYW1uYW5yenJ1enZrZWhweWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NTM1NTMsImV4cCI6MjA2MTMyOTU1M30.L0Ytkxi80AbYjkjpDfGyQtfyfqjfHLF98OrVce9Hi-0'; // nhập key đầy đủ tại đây

    async function getBinanceApiKeysFromSupabase() {
      const rawUser = localStorage.getItem("loggedInUser");
      if (!rawUser) throw new Error("Chưa đăng nhập Supabase");
      const user = JSON.parse(rawUser);
      const user_id = user.user_id;

      const url = `${SUPABASE_URL}/rest/v1/users?select=apikey_binance,secret_binance&user_id=eq.${user_id}`;
      const res = await fetch(url, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          Accept: 'application/json',
        }
      });

      const data = await res.json();
      if (!data || data.length === 0) throw new Error("Không tìm thấy API key trong Supabase");
      return data[0];
    }

    async function getBinanceFuturesBalanceAndLeverage(apiKey, apiSecret) {
      const timestamp = Date.now();
      const queryString = `timestamp=${timestamp}`;
      const signature = CryptoJS.HmacSHA256(queryString, apiSecret).toString();

      // Lấy số dư Futures
      const accountInfoUrl = `https://fapi.binance.com/fapi/v2/account?${queryString}&signature=${signature}`;
      const res1 = await fetch(accountInfoUrl, {
        method: 'GET',
        headers: {
          'X-MBX-APIKEY': apiKey
        }
      });
      const balanceData = await res1.json();

      // Lấy leverage từng coin
      const symbols = balanceData.positions
        .filter(p => parseFloat(p.initialMargin) > 0)
        .map(p => p.symbol);

      const leverages = {};
      for (const symbol of symbols) {
        const qs = `symbol=${symbol}&timestamp=${timestamp}`;
        const sig = CryptoJS.HmacSHA256(qs, apiSecret).toString();
        const url = `https://fapi.binance.com/fapi/v1/leverageBracket?${qs}&signature=${sig}`;
        const res = await fetch(url, {
          headers: { 'X-MBX-APIKEY': apiKey }
        });
        const data = await res.json();
        leverages[symbol] = data?.[0]?.brackets?.[0]?.initialLeverage || 'N/A';
      }

      return { balanceData, leverages };
    }

    // Gọi toàn bộ
    (async () => {
      try {
        const { apikey_binance, secret_binance } = await getBinanceApiKeysFromSupabase();
        const result = await getBinanceFuturesBalanceAndLeverage(apikey_binance, secret_binance);

        let out = `Tổng số dư Futures: ${result.balanceData.totalWalletBalance} USDT\n\n`;
        out += `Đòn bẩy các cặp đang mở:\n`;
        for (const [symbol, lev] of Object.entries(result.leverages)) {
          out += `${symbol}: ${lev}x\n`;
        }

        document.getElementById('output').innerText = out;
      } catch (e) {
        document.getElementById('output').innerText = "LỖI: " + e.message;
      }
    })();
  </script>
</body>
</html>
