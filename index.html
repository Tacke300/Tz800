<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TZ800 BOT</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #ffffff;
      text-align: center;
    }
    .marquee {
      background-color: #ff9800;
      padding: 15px 0;
      font-size: 24px;
      font-weight: bold;
      overflow: hidden;
      position: relative;
    }
    .marquee p {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 10s linear infinite;
      margin: 0;
    }
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    .box-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .box {
      width: 120px;
      height: 80px;
      margin: 10px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }
    .green {
      background-color: #4caf50;
    }
    .red {
      background-color: #f44336;
    }
    #userId {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
    .menu {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background-color: #2196f3;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 10px;
    }
    button:hover {
      background-color: #0b7dda;
    }
    .popup, .apikey {
      display: none;
      background-color: #333;
      padding: 20px;
      border-radius: 10px;
      margin: 20px;
    }
    input[type="text"], input[type="password"] {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: none;
    }
  </style>
</head>
<body>

<div class="marquee">
  <p>TZ800 - TRADE BOT OKX</p>
</div>

<div class="box-container">
  <div class="box green">WIN</div>
  <div class="box red">LOSE</div>
</div>

<p>ID: <span id="userId">Đang tải...</span></p>

<div class="menu" id="buttonMenu">
  <button onclick="showPopup()">SET API</button>
  <button onclick="showAPIKey()">?</button>
  <button onclick="showBase()">BASE</button>
</div>

<div id="popup" class="popup">
  <p>API KEY:</p>
  <input type="text" id="apikeyinput">
  <p>API SECRET:</p>
  <input type="password" id="apisecretinput">
  <p>PASSPHRASE:</p>
  <input type="text" id="passphraseinput"><br>
  <button onclick="submitData()">SUBMIT</button>
  <button onclick="closePopup()">ĐÓNG</button>
</div>

<div id="apikey" class="apikey">
  <p>Đăng nhập OKX → API Management → Create API Key (API v5) → Chọn quyền giao dịch.</p>
  <p><strong>Note:</strong> API SECRET chỉ hiện 1 lần sau khi tạo, nhớ lưu lại!</p>
  <button onclick="closePopup()">ĐÓNG</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = supabase.createClient('https://tramnanrzruzvkehpydl.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...');
  
  const userTelegramId = '123456789'; // <-- THAY ID telegram vào đây

  async function fetchOrInsertTelegramId() {
    try {
      let { data, error } = await supabase
        .from('telegram_id')
        .select('telegram_id')
        .eq('telegram_id', userTelegramId)
        .maybeSingle();
      if (data) {
        document.getElementById('userId').innerText = data.telegram_id;
      } else {
        let { data: newData, error: insertError } = await supabase
          .from('telegram_id')
          .insert([{ telegram_id: userTelegramId }])
          .select('telegram_id')
          .single();
        if (insertError) throw insertError;
        document.getElementById('userId').innerText = newData.telegram_id;
      }
    } catch (err) {
      console.error(err);
      document.getElementById('userId').innerText = "Lỗi";
    }
  }

  async function submitData() {
    const apiKey = document.getElementById('apikeyinput').value.trim();
    const apiSecret = document.getElementById('apisecretinput').value.trim();
    const passphrase = document.getElementById('passphraseinput').value.trim();
    if (!apiKey || !apiSecret || !passphrase) {
      alert("Vui lòng nhập đủ thông tin!");
      return;
    }
    try {
      let { error } = await supabase
        .from('apikey')
        .insert([{ telegram_id: userTelegramId, api_key: apiKey, api_secret: apiSecret, passphrase: passphrase }]);
      if (error) {
        alert("Có lỗi: " + error.message);
      } else {
        alert("Đã lưu API thành công!");
        closePopup();
      }
    } catch (err) {
      console.error(err);
      alert("Đã xảy ra lỗi!");
    }
  }

  async function showBase() {
    try {
      let { data, error } = await supabase
        .from('apikey')
        .select('*')
        .eq('telegram_id', userTelegramId)
        .maybeSingle();
      if (data) {
        document.getElementById('apikeyinput').value = data.api_key || '';
        document.getElementById('apisecretinput').value = data.api_secret || '';
        document.getElementById('passphraseinput').value = data.passphrase || '';
        showPopup();
      } else {
        alert("Không tìm thấy API!");
      }
    } catch (err) {
      console.error(err);
      alert("Đã xảy ra lỗi khi lấy dữ liệu!");
    }
  }

  function showPopup() {
    document.getElementById('popup').style.display = 'block';
    document.getElementById('apikey').style.display = 'none';
    document.getElementById('buttonMenu').style.display = 'none';
  }

  function showAPIKey() {
    document.getElementById('apikey').style.display = 'block';
    document.getElementById('popup').style.display = 'none';
    document.getElementById('buttonMenu').style.display = 'none';
  }

  function closePopup() {
    document.getElementById('popup').style.display = 'none';
    document.getElementById('apikey').style.display = 'none';
    document.getElementById('buttonMenu').style.display = 'flex';
  }

  fetchOrInsertTelegramId();
</script>

</body>
</html>
