<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý API Key</title>
  <style>
    #popup, #apikey {
      display: none;
      background: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      margin: 20px auto;
      width: 300px;
      border-radius: 8px;
    }
    #buttonMenu {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 40px;
      gap: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

  <div id="buttonMenu">
    <div>ID Telegram: <span id="userId"></span></div>
    <button onclick="showBase()">Xem API Đã Lưu</button>
    <button onclick="showAPIKey()">Thêm API Key Mới</button>
  </div>

  <div id="popup">
    <h3>Thông tin API</h3>
    <input id="apikeyinput" type="text" placeholder="API KEY" style="width: 100%; margin-bottom: 10px;">
    <input id="apisecretinput" type="text" placeholder="API SECRET" style="width: 100%; margin-bottom: 10px;">
    <input id="passphraseinput" type="text" placeholder="PASSPHRASE" style="width: 100%; margin-bottom: 10px;">
    <button onclick="submitData()">Gửi API Key</button>
    <button onclick="closePopup()" style="background-color: #f44336;">Đóng</button>
  </div>

  <div id="apikey">
    <h3>Nhập API Mới</h3>
    <input id="apikeyinput" type="text" placeholder="API KEY" style="width: 100%; margin-bottom: 10px;">
    <input id="apisecretinput" type="text" placeholder="API SECRET" style="width: 100%; margin-bottom: 10px;">
    <input id="passphraseinput" type="text" placeholder="PASSPHRASE" style="width: 100%; margin-bottom: 10px;">
    <button onclick="submitData()">Gửi API Key</button>
    <button onclick="closePopup()" style="background-color: #f44336;">Đóng</button>
  </div>

  <!-- Import Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://tramnanrzruzvkehpydl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // <-- Bạn thay bằng key đầy đủ ở đây
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const userTelegramId = '123456789'; // <-- Điền đúng Telegram ID của người dùng

    async function fetchOrInsertTelegramId() {
      try {
        const { data, error } = await supabase
          .from('telegram_id')
          .select('telegram_id')
          .eq('telegram_id', userTelegramId);

        if (error) throw error;

        if (data.length > 0) {
          document.getElementById('userId').innerText = data[0].telegram_id;
        } else {
          const { data: insertedData, error: insertError } = await supabase
            .from('telegram_id')
            .insert([{ telegram_id: userTelegramId }])
            .select();
          if (insertError) throw insertError;
          document.getElementById('userId').innerText = insertedData[0].telegram_id;
        }
      } catch (err) {
        console.error('Lỗi fetchOrInsertTelegramId:', err.message);
        document.getElementById('userId').innerText = "Lỗi";
      }
    }

    async function submitData() {
      const apiKey = document.getElementById('apikeyinput').value.trim();
      const apiSecret = document.getElementById('apisecretinput').value.trim();
      const passphrase = document.getElementById('passphraseinput').value.trim();

      if (!apiKey || !apiSecret || !passphrase) {
        alert("Vui lòng nhập đủ API KEY, SECRET và PASSPHRASE!");
        return;
      }

      try {
        const { error } = await supabase
          .from('apikey')
          .insert([
            {
              telegram_id: userTelegramId,
              api_key: apiKey,
              api_secret: apiSecret,
              passphrase: passphrase
            }
          ]);
        if (error) throw error;
        alert("Đã lưu API thành công!");
        closePopup();
      } catch (err) {
        console.error('Lỗi submitData:', err.message);
        alert("Gửi API thất bại: " + err.message);
      }
    }

    async function showBase() {
      try {
        const { data, error } = await supabase
          .from('apikey')
          .select('*')
          .eq('telegram_id', userTelegramId);

        if (error) throw error;

        if (data.length > 0) {
          const info = data[0];
          document.getElementById('apikeyinput').value = info.api_key || '';
          document.getElementById('apisecretinput').value = info.api_secret || '';
          document.getElementById('passphraseinput').value = info.passphrase || '';
          showPopup();
        } else {
          alert("Không tìm thấy API!");
        }
      } catch (err) {
        console.error('Lỗi showBase:', err.message);
        alert("Đã xảy ra lỗi!");
      }
    }

    function showPopup() {
      document.getElementById('popup').style.display = 'block';
      document.getElementById('apikey').style.display = 'none';
      document.getElementById('buttonMenu').style.display = 'none';
    }

    function showAPIKey() {
      document.getElementById('apikey').style.display = 'block';
      document.getElementById('popup').style.display = 'none';
      document.getElementById('buttonMenu').style.display = 'none';
    }

    function closePopup() {
      document.getElementById('popup').style.display = 'none';
      document.getElementById('apikey').style.display = 'none';
      document.getElementById('buttonMenu').style.display = 'flex';
    }

    fetchOrInsertTelegramId();
  </script>

</body>
</html>
