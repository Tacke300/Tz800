<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OKX USDT Balance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      font-size: 24px;
    }
    .balance-box {
      background-color: #f1f1f1;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
      font-size: 18px;
    }
    .loading {
      color: #FF9800;
      font-size: 18px;
    }
    .error {
      color: #FF5722;
      font-size: 18px;
    }
    .success {
      color: #4CAF50;
      font-size: 18px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Kiểm Tra Số Dư USDT</h1>
    <div class="balance-box">
      <p class="loading">Đang tải số dư USDT...</p>
      <p class="balance success" id="balance">Số dư USDT sẽ hiển thị ở đây</p>
      <p class="error" id="error-message" style="display:none;">Lỗi trong quá trình lấy số dư.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@3.3.0/core.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@3.3.0/sha256.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
  <script>
    // ==================== CẤU HÌNH ====================
    const SUPABASE_URL = 'https://your-project.supabase.co'; // URL Supabase của bạn
    const SUPABASE_KEY = 'your-service-role-key'; // Service role key của bạn
    const TELEGRAM_ID = '123456789'; // ID Telegram người dùng

    // ==================== HÀM LẤY APIKEY TỪ SUPABASE ====================
    async function getUserApiKeys(userId) {
      try {
        const response = await axios.post(SUPABASE_URL + '/rest/v1/users', {
          headers: {
            'apikey': SUPABASE_KEY,
          },
        });

        return response.data[0];  // Giả sử Supabase trả về dữ liệu API key trong mảng
      } catch (error) {
        throw new Error('Lỗi lấy API từ Supabase: ' + error.message);
      }
    }

    // ==================== HÀM LẤY TIMESTAMP OKX ====================
    async function getOkxTimestamp() {
      try {
        const response = await axios.get('https://www.okx.com/api/v5/public/time');
        return response.data.data[0].ts;
      } catch (error) {
        throw new Error("Lỗi lấy timestamp: " + error.message);
      }
    }

    // ==================== HÀM KÝ ====================
    function sign(timestamp, method, path, body, secret) {
      const msg = timestamp + method + path + body;
      return crypto.HmacSHA256(msg, secret).toString(crypto.enc.Base64);
    }

    // ==================== HÀM LẤY SỐ DƯ USDT ====================
    async function getUsdtBalance() {
      const balanceElement = document.getElementById('balance');
      const errorMessageElement = document.getElementById('error-message');
      const loadingElement = document.querySelector('.loading');
      
      try {
        const { apikey, secret, pass } = await getUserApiKeys(TELEGRAM_ID);
        const timestamp = await getOkxTimestamp();
        const method = 'GET';
        const path = '/api/v5/account/balance';
        const body = '';
        const signature = sign(timestamp, method, path, body, secret);

        const response = await axios.get('https://www.okx.com/api/v5/account/balance', {
          headers: {
            'OK-ACCESS-KEY': apikey,
            'OK-ACCESS-SIGN': signature,
            'OK-ACCESS-TIMESTAMP': timestamp,
            'OK-ACCESS-PASSPHRASE': pass,
            'Content-Type': 'application/json',
          },
        });

        const details = response.data.data?.[0]?.details || [];
        const usdt = details.find(i => i.ccy === 'USDT');
        if (usdt) {
          balanceElement.textContent = `Số dư USDT: ${usdt.availBal}`;
          loadingElement.style.display = 'none';
          balanceElement.style.display = 'block';
        } else {
          throw new Error("Không tìm thấy USDT.");
        }
      } catch (error) {
        loadingElement.style.display = 'none';
        errorMessageElement.style.display = 'block';
      }
    }

    // ==================== CHẠY LIÊN TỤC MỖI GIÂY ====================
    setInterval(getUsdtBalance, 1000);
  </script>

</body>
</html>
